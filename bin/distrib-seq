#!/bin/sh
#
# To distribute files under input directory to the same dir in the server list
# ip/hostname each line in server list file
#
# Usage:
#   distrib <source dir> <dest dir> <server list file>
#

trap "echo 'signal.....quit'; exit" SIGHUP SIGINT SIGTERM

help(){
    echo "Usage: distrib <-make|-copy> <source dir|dest dir> <server list file>"
    echo
}

CMD=$1
shift
case $CMD in
    -make)
        srcdir=$1
        slaves=$2
        
        files=`ls $srcdir`
        files_arr=(`ls $srcdir`)
        target=(`cat $slaves`)
        
        #mkdir output buffer dir
        for d in ${target[*]}; do
            mkdir -p $d
        done
        
        #prepare the output files
        curid=0
        
        filecnt=${#files_arr[*]}
        hostcnt=${#target[*]}
        chunksize=`echo "$filecnt/$hostcnt" |bc`
        remainnum=`echo "$filecnt - $chunksize*$hostcnt" |bc`
        echo "Chunk size=", $chunksize
        echo "Remainder cnt=", $remainnum
        echo "Total file cnt=", $filecnt
        echo "Server cnt=", ${#target[*]}
        
        
        #start distribute
        fid=0
        #for id in ${seq 0 1 $hostcnt}; do
        for ((id=0; id<$hostcnt; id++)); do
        #    for j in ${seq 1 1 $chunksize}; do
            for ((j =0; j< $chunksize ; j++)); do
                ln -s $srcdir/${files_arr[fid]} ${target[id]}/${files_arr[fid]} 
                ((fid++))
            done
        
            if [ $id -lt $remainnum ]; then
                ln -s $srcdir/${files_arr[fid]} ${target[id]}/${files_arr[fid]} 
                ((fid++))
            fi
        done
        echo "Bye"

    ;;

    -copy)
        destdir=$1
        slaves=$2
        target=(`cat $slaves`)
        ##cexec mkdir -p $destdir
        for s in ${target[*]}; do
            echo "copy file to $s:$destdir"
            ssh $s mkdir -p $destdir
            scp -r $s $s:$destdir
            #ssh $s "cd $destdir && for f in `ls $s`; do mv \$f .; done"
            #ssh $s "cd $destdir && mv $s/* ."
        done

        echo "Bye"
    ;;

    *) echo "Unrecognized command: $CMD"; help; exit 1;;
esac
